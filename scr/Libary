-- =============================================
-- GROKUI v3 - Catch-up Edition (Feb 2026)
-- Added: Dropdown, Keybind, ColorPicker, Notifications, Paragraph, basic Flags/Config
-- =============================================

local GrokUI = {}
local TS = game:GetService("TweenService")
local UIS = game:GetService("UserInputService")
local HS = game:GetService("HttpService")
local Players = game:GetService("Players")

local DEFAULT_THEME = {
    Name = "Default Dark",
    Accent       = Color3.fromRGB(100, 180, 255),
    Background   = Color3.fromRGB(16, 16, 24),
    Secondary    = Color3.fromRGB(24, 24, 38),
    Tertiary     = Color3.fromRGB(36, 36, 52),
    Text         = Color3.fromRGB(240, 240, 255),
    TextDim      = Color3.fromRGB(170, 170, 190),
    Border       = Color3.fromRGB(55, 55, 80),
    Shadow       = Color3.fromRGB(0, 0, 0),
    GradientStart = Color3.fromRGB(30, 30, 45),
}

function GrokUI:CreateWindow(options)
    options = options or {}
    local title     = options.Title or "GrokUI"
    local theme     = options.Theme or DEFAULT_THEME
    local sizeX     = options.SizeX or 740
    local sizeY     = options.SizeY or 540
    local saveConfig = options.SaveConfig or false
    local configFolder = options.ConfigFolder or "GrokUI_Config"

    local sg = Instance.new("ScreenGui")
    sg.Name = "GrokUI_v3"
    sg.ResetOnSpawn = false
    sg.Parent = game:GetService("CoreGui")

    -- Main frame (same as before, abbreviated for space)
    local Main = Instance.new("Frame")
    Main.Size = UDim2.new(0, sizeX, 0, sizeY)
    Main.Position = UDim2.new(0.5, -sizeX/2, 0.5, -sizeY/2)
    Main.BackgroundColor3 = theme.Background
    Main.BorderSizePixel = 0
    Main.Parent = sg

    local corner = Instance.new("UICorner"); corner.CornerRadius = UDim.new(0,16); corner.Parent = Main
    -- ... (add gradient, stroke, glow like v2)

    -- TitleBar, Close, Dragging (same as v2, omitted for brevity)

    -- Content, TabBar, tabContent (same structure)

    local Window = {}
    local Flags = {}           -- for config
    local Connections = {}     -- cleanup

    -- Notification system
    local NotifQueue = {}
    function Window:Notify(title, content, duration)
        duration = duration or 5

        local notif = Instance.new("Frame")
        notif.Size = UDim2.new(0, 300, 0, 80)
        notif.Position = UDim2.new(1, -320, 1, -100 - (#NotifQueue * 90))
        notif.BackgroundColor3 = theme.Secondary
        notif.BorderSizePixel = 0
        notif.Parent = sg

        local nc = Instance.new("UICorner"); nc.CornerRadius = UDim.new(0,10); nc.Parent = notif

        local titleLbl = Instance.new("TextLabel")
        titleLbl.Size = UDim2.new(1,0,0,30)
        titleLbl.BackgroundTransparency = 1
        titleLbl.Text = title
        titleLbl.TextColor3 = theme.Text
        titleLbl.Font = Enum.Font.GothamBold
        titleLbl.TextSize = 16
        titleLbl.Parent = notif

        local cont = Instance.new("TextLabel")
        cont.Size = UDim2.new(1,0,0,50)
        cont.Position = UDim2.new(0,0,0,30)
        cont.BackgroundTransparency = 1
        cont.Text = content
        cont.TextColor3 = theme.TextDim
        cont.TextWrapped = true
        cont.Font = Enum.Font.Gotham
        cont.TextSize = 14
        cont.Parent = notif

        table.insert(NotifQueue, notif)

        TS:Create(notif, TweenInfo.new(0.4, Enum.EasingStyle.Quint), {Position = UDim2.new(1, -320, 1, -100 - (#NotifQueue * 90))}):Play()

        task.delay(duration, function()
            TS:Create(notif, TweenInfo.new(0.4), {Position = UDim2.new(1, 20, notif.Position.Y.Scale, notif.Position.Y.Offset)}):Play()
            task.delay(0.4, function()
                notif:Destroy()
                table.remove(NotifQueue, table.find(NotifQueue, notif))
            end)
        end)
    end

    -- Flag system (basic save/load)
    function Window:SetFlag(key, value)
        Flags[key] = value
        if saveConfig then
            pcall(function()
                if not isfolder(configFolder) then makefolder(configFolder) end
                writefile(configFolder .. "/config.json", HS:JSONEncode(Flags))
            end)
        end
    end

    function Window:GetFlag(key, default)
        return Flags[key] or default
    end

    -- Load config on start
    if saveConfig then
        pcall(function()
            if isfile(configFolder .. "/config.json") then
                Flags = HS:JSONDecode(readfile(configFolder .. "/config.json"))
            end
        end)
    end

    -- Tab creation (same base, add new methods below)
    function Window:CreateTab(name, iconName)
        -- ... (same as v2: tab button, frame, auto-select first)

        local Tab = {}

        -- Existing: Label, Button, Toggle, Slider

        function Tab:CreateParagraph(title, content)
            local frame = Instance.new("Frame")
            frame.Size = UDim2.new(1,0,0,80)
            frame.BackgroundTransparency = 1
            frame.Parent = frame -- your tab scrolling frame

            local t = Instance.new("TextLabel")
            t.Size = UDim2.new(1,0,0,25)
            t.BackgroundTransparency = 1
            t.Text = title
            t.TextColor3 = theme.Text
            t.Font = Enum.Font.GothamBold
            t.TextSize = 16
            t.Parent = frame

            local c = Instance.new("TextLabel")
            c.Size = UDim2.new(1,0,1,-25)
            c.Position = UDim2.new(0,0,0,25)
            c.BackgroundTransparency = 1
            c.Text = content
            c.TextColor3 = theme.TextDim
            c.TextWrapped = true
            c.Font = Enum.Font.Gotham
            c.TextSize = 14
            c.TextXAlignment = Enum.TextXAlignment.Left
            c.Parent = frame

            return frame
        end

        function Tab:CreateDropdown(options)
            options = options or {}
            local items = options.Items or {}
            local default = options.Default or items[1]
            local callback = options.Callback
            local searchable = options.Searchable or false
            local flag = options.Flag

            local ddFrame = Instance.new("Frame")
            ddFrame.Size = UDim2.new(1,0,0,40)
            ddFrame.BackgroundColor3 = theme.Tertiary
            ddFrame.Parent = frame -- tab frame

            local ddCorner = Instance.new("UICorner"); ddCorner.CornerRadius = UDim.new(0,8); ddCorner.Parent = ddFrame

            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(0.7,0,1,0)
            label.BackgroundTransparency = 1
            label.Text = default or "Select..."
            label.TextColor3 = theme.Text
            label.Font = Enum.Font.GothamSemibold
            label.TextSize = 15
            label.Parent = ddFrame

            local arrow = Instance.new("TextLabel")
            arrow.Size = UDim2.new(0,30,1,0)
            arrow.Position = UDim2.new(1,-35,0,0)
            arrow.BackgroundTransparency = 1
            arrow.Text = "▼"
            arrow.TextColor3 = theme.TextDim
            arrow.Font = Enum.Font.GothamBold
            arrow.TextSize = 18
            arrow.Parent = ddFrame

            local list = Instance.new("ScrollingFrame")
            list.Size = UDim2.new(1,0,0,0)
            list.Position = UDim2.new(0,0,1,5)
            list.BackgroundColor3 = theme.Secondary
            list.BorderSizePixel = 0
            list.Visible = false
            list.ScrollBarThickness = 4
            list.Parent = ddFrame

            local listLayout = Instance.new("UIListLayout")
            listLayout.Padding = UDim.new(0,4)
            listLayout.Parent = list

            local listPad = Instance.new("UIPadding")
            listPad.PaddingTop = UDim.new(0,6)
            listPad.PaddingBottom = UDim.new(0,6)
            listPad.PaddingLeft = UDim.new(0,8)
            listPad.PaddingRight = UDim.new(0,8)
            listPad.Parent = list

            local searchBox
            if searchable then
                searchBox = Instance.new("TextBox")
                searchBox.Size = UDim2.new(1,-16,0,30)
                searchBox.Position = UDim2.new(0,8,0,6)
                searchBox.BackgroundColor3 = theme.Tertiary
                searchBox.Text = ""
                searchBox.PlaceholderText = "Search..."
                searchBox.TextColor3 = theme.Text
                searchBox.PlaceholderColor3 = theme.TextDim
                searchBox.ClearTextOnFocus = false
                searchBox.Parent = list
                list.CanvasSize = UDim2.new(0,0,0, #items * 34 + 50)
            end

            local selected = default

            local function updateList(filter)
                for _, child in list:GetChildren() do
                    if child:IsA("TextButton") then child:Destroy() end
                end

                for _, item in items do
                    if filter and not string.find(item:lower(), filter:lower()) then continue end

                    local btn = Instance.new("TextButton")
                    btn.Size = UDim2.new(1,0,0,30)
                    btn.BackgroundColor3 = theme.Tertiary
                    btn.Text = tostring(item)
                    btn.TextColor3 = theme.Text
                    btn.Font = Enum.Font.Gotham
                    btn.TextSize = 14
                    btn.Parent = list

                    local bc = Instance.new("UICorner"); bc.CornerRadius = UDim.new(0,6); bc.Parent = btn

                    btn.MouseButton1Click:Connect(function()
                        selected = item
                        label.Text = tostring(item)
                        list.Visible = false
                        if callback then callback(item) end
                        if flag then Window:SetFlag(flag, item) end
                    end)
                end
            end

            updateList()

            if searchable and searchBox then
                searchBox.FocusLost:Connect(function()
                    updateList(searchBox.Text)
                end)
            end

            ddFrame.InputBegan:Connect(function(inp)
                if inp.UserInputType == Enum.UserInputType.MouseButton1 then
                    list.Visible = not list.Visible
                    if list.Visible then
                        list.Size = UDim2.new(1,0,0, math.min(#items * 34 + (searchable and 40 or 0), 200))
                    else
                        list.Size = UDim2.new(1,0,0,0)
                    end
                end
            end)

            return ddFrame
        end

        function Tab:CreateKeybind(options)
            options = options or {}
            local text = options.Text or "Keybind"
            local default = options.Default or Enum.KeyCode.Unknown
            local callback = options.Callback
            local flag = options.Flag

            local kbFrame = Instance.new("Frame")
            kbFrame.Size = UDim2.new(1,0,0,40)
            kbFrame.BackgroundTransparency = 1
            kbFrame.Parent = frame

            local lbl = Instance.new("TextLabel")
            lbl.Size = UDim2.new(0.6,0,1,0)
            lbl.BackgroundTransparency = 1
            lbl.Text = text
            lbl.TextColor3 = theme.Text
            lbl.Font = Enum.Font.GothamSemibold
            lbl.TextSize = 15
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Parent = kbFrame

            local bindBox = Instance.new("TextButton")
            bindBox.Size = UDim2.new(0,120,0,30)
            bindBox.Position = UDim2.new(1,-130,0.5,-15)
            bindBox.BackgroundColor3 = theme.Tertiary
            bindBox.Text = default.Name or "[...]"
            bindBox.TextColor3 = theme.Text
            bindBox.Font = Enum.Font.Gotham
            bindBox.TextSize = 14
            bindBox.Parent = kbFrame

            local bc = Instance.new("UICorner"); bc.CornerRadius = UDim.new(0,6); bc.Parent = bindBox

            local listening = false

            bindBox.MouseButton1Click:Connect(function()
                listening = true
                bindBox.Text = "[...]"
            end)

            local conn = UIS.InputBegan:Connect(function(inp)
                if listening and inp.KeyCode ~= Enum.KeyCode.Unknown then
                    listening = false
                    local key = inp.KeyCode
                    bindBox.Text = key.Name
                    if callback then callback(key) end
                    if flag then Window:SetFlag(flag, key.Name) end
                end
            end)
            table.insert(Connections, conn)

            return kbFrame
        end

        function Tab:CreateColorPicker(options)
            options = options or {}
            local text = options.Text or "Color"
            local default = options.Default or Color3.fromRGB(255,100,100)
            local callback = options.Callback
            local flag = options.Flag

            local cpFrame = Instance.new("Frame")
            cpFrame.Size = UDim2.new(1,0,0,100)
            cpFrame.BackgroundTransparency = 1
            cpFrame.Parent = frame

            local lbl = Instance.new("TextLabel")
            lbl.Size = UDim2.new(1,0,0,25)
            lbl.BackgroundTransparency = 1
            lbl.Text = text
            lbl.TextColor3 = theme.Text
            lbl.Font = Enum.Font.GothamSemibold
            lbl.TextSize = 15
            lbl.Parent = cpFrame

            local preview = Instance.new("Frame")
            preview.Size = UDim2.new(0,80,0,80)
            preview.Position = UDim2.new(0,10,0,25)
            preview.BackgroundColor3 = default
            preview.Parent = cpFrame

            local pCorner = Instance.new("UICorner"); pCorner.CornerRadius = UDim.new(0,8); pCorner.Parent = preview

            -- Simple HSV picker (expandable later)
            local picker = Instance.new("TextButton")
            picker.Size = UDim2.new(0,200,0,80)
            picker.Position = UDim2.new(0,100,0,25)
            picker.BackgroundColor3 = Color3.new(1,0,0)
            picker.Text = ""
            picker.Parent = cpFrame

            -- ... (add gradient, hue slider, etc. – basic version for now)

            picker.MouseButton1Click:Connect(function()
                -- Simulate pick (in real: open full picker UI)
                local newColor = Color3.fromHSV(math.random(), 1, 1) -- placeholder
                preview.BackgroundColor3 = newColor
                if callback then callback(newColor) end
                if flag then Window:SetFlag(flag, {newColor.R, newColor.G, newColor.B}) end
            end)

            return cpFrame
        end

        return Tab
    end

    function Window:Destroy()
        for _, conn in Connections do conn:Disconnect() end
        sg:Destroy()
    end

    return Window
end

return GrokUI
